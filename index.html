<script>
        const WEATHER_API_KEY = "bbf6173c6ac5f37e5daf19452e460d19";
        
        // DÄ°KKAT: Buraya yeni aldÄ±ÄŸÄ±n anahtarÄ± tÄ±rnak iÃ§ine yapÄ±ÅŸtÄ±r ğŸ‘‡
        const GEMINI_API_KEY = "AIzaSyC9bvp1ByQ83TsiMeYFZXjTPcSk3LMaotU"; 

        const backgrounds = {
            Clear: "url('https://images.unsplash.com/photo-1601297183305-6df142704ea2?q=80&w=1000&auto=format&fit=crop')",
            Clouds: "url('https://images.unsplash.com/photo-1534088568595-a066f410bcda?q=80&w=1000&auto=format&fit=crop')",
            Rain: "url('https://images.unsplash.com/photo-1515694346937-94d85e41e6f0?q=80&w=1000&auto=format&fit=crop')",
            Snow: "url('https://images.unsplash.com/photo-1477601263568-180e2c6d046e?q=80&w=1000&auto=format&fit=crop')",
            Thunderstorm: "url('https://images.unsplash.com/photo-1605727216801-e27ce1ca8728?q=80&w=1000&auto=format&fit=crop')",
            Drizzle: "url('https://images.unsplash.com/photo-1541919329513-35f7af297129?q=80&w=1000&auto=format&fit=crop')",
            Mist: "url('https://images.unsplash.com/photo-1485236715568-ddc5ee6ca227?q=80&w=1000&auto=format&fit=crop')",
            Default: "url('https://images.unsplash.com/photo-1500964757637-c85e8a162699?q=80&w=1000&auto=format&fit=crop')"
        };

        let groupedDays = {};
        let currentCityName = "";

        window.onload = function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    getWeather(pos.coords.latitude, pos.coords.longitude);
                }, () => { getWeather(41.0082, 28.9784); });
            } else { getWeather(41.0082, 28.9784); }
        };

        function toggleSearch() {
            const box = document.getElementById('search-box');
            const badge = document.getElementById('location-badge');
            if(box.style.display === 'flex') { box.style.display='none'; badge.style.display='inline-flex'; }
            else { badge.style.display='none'; box.style.display='flex'; document.getElementById('city-input').focus(); }
        }

        async function searchCity() {
            const city = document.getElementById('city-input').value;
            if (!city) return;
            const geoUrl = `https://api.openweathermap.org/geo/1.0/direct?q=${city}&limit=1&appid=${WEATHER_API_KEY}`;
            try {
                const response = await fetch(geoUrl);
                const data = await response.json();
                if (data.length > 0) {
                    toggleSearch();
                    currentCityName = data[0].name;
                    document.getElementById('loc-text').innerText = `${data[0].name}, ${data[0].country}`;
                    getWeather(data[0].lat, data[0].lon, true);
                } else { alert("Åehir bulunamadÄ±."); }
            } catch (e) { alert("Hata."); }
        }

        document.getElementById("city-input").addEventListener("keypress", function(e) { if (e.key === "Enter") searchCity(); });

        async function getWeather(lat, lon, manual=false) {
            try {
                const response = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric&lang=tr`);
                if(!response.ok) throw new Error();
                const data = await response.json();
                if(!manual) {
                    currentCityName = data.city.name;
                    document.getElementById('loc-text').innerText = currentCityName;
                }
                document.getElementById('sim-warning').style.display = 'none';
                processData(data.list);
            } catch (e) {
                document.getElementById('sim-warning').style.display = 'block';
                processData(createFakeData());
                currentCityName = "Ä°stanbul";
                document.getElementById('loc-text').innerText = "Ä°stanbul (Test)";
            }
        }

        function createFakeData() {
            let arr = []; let now = Math.floor(Date.now()/1000);
            for(let i=0; i<5; i++) {
                let s = now + (i*86400);
                arr.push({dt:s+36000, dt_txt:"09:00", main:{temp:20}, weather:[{main:'Clear'}], wind:{speed:5}});
                arr.push({dt:s+54000, dt_txt:"15:00", main:{temp:25}, weather:[{main:'Clear'}], wind:{speed:10}});
                arr.push({dt:s+75600, dt_txt:"21:00", main:{temp:15}, weather:[{main:'Clouds'}], wind:{speed:15}});
            }
            return arr;
        }

        function processData(list) {
            groupedDays = {};
            list.forEach(item => {
                const date = new Date(item.dt*1000).toLocaleDateString('tr-TR', {weekday:'long', day:'numeric', month:'long'});
                const short = new Date(item.dt*1000).toLocaleDateString('tr-TR', {weekday:'short', day:'numeric'});
                if(!groupedDays[date]) groupedDays[date] = {full:date, short:short, hours:[]};
                groupedDays[date].hours.push(item);
            });
            renderButtons();
        }

        function renderButtons() {
            const wrapper = document.getElementById('days-wrapper');
            wrapper.innerHTML = '';
            const keys = Object.keys(groupedDays).slice(0,5);
            keys.forEach((key, i) => {
                const day = groupedDays[key];
                const temp = Math.round((day.hours[Math.floor(day.hours.length/2)] || day.hours[0]).main.temp);
                const btn = document.createElement('div');
                btn.className = `day-btn ${i===0?'active':''}`;
                btn.innerHTML = `<span class="d-name">${day.short}</span><span class="d-temp">${temp}Â°</span>`;
                btn.onclick = () => {
                    document.querySelectorAll('.day-btn').forEach(b=>b.classList.remove('active'));
                    btn.classList.add('active');
                    selectDay(key);
                };
                wrapper.appendChild(btn);
            });
            if(keys.length>0) selectDay(keys[0]);
        }

        function selectDay(key) {
            const day = groupedDays[key];
            document.getElementById('selected-date-title').innerText = day.full;
            const m = findHour(day.hours, 9);
            const n = findHour(day.hours, 15);
            const e = findHour(day.hours, 21);
            renderTimeline(m, n, e);
            askGemini(currentCityName, day.full, m, n, e);
            const mainWeather = n ? n.weather[0].main : (m ? m.weather[0].main : 'Default');
            changeBackground(mainWeather);
        }

        function changeBackground(weather) {
            const bgDiv = document.getElementById('dynamic-bg');
            const imgUrl = backgrounds[weather] || backgrounds.Default;
            bgDiv.style.backgroundImage = imgUrl;
        }

        function findHour(list, h) {
            if(!list.length) return null;
            return list.reduce((p,c) => {
                const pH = new Date(p.dt*1000).getHours();
                const cH = new Date(c.dt*1000).getHours();
                return (Math.abs(cH-h) < Math.abs(pH-h) ? c : p);
            });
        }

        function renderTimeline(m,n,e) {
            if(!m)m=n||e; if(!n)n=m||e; if(!e)e=n||m;
            const list = [{l:'SABAH',d:m}, {l:'Ã–ÄLE',d:n}, {l:'AKÅAM',d:e}];
            let html = '';
            list.forEach(p => {
                const icon = getIcon(p.d.weather[0].main);
                html += `<div class="time-slot"><div class="ts-label">${p.l}</div><div class="ts-icon">${icon}</div><div class="ts-temp">${Math.round(p.d.main.temp)}Â°</div><div class="ts-wind">ğŸ’¨ ${Math.round(p.d.wind.speed)}</div></div>`;
            });
            document.getElementById('timeline-view').innerHTML = html;
        }

        function getIcon(m) {
            if(m.includes('Clear')) return 'â˜€ï¸';
            if(m.includes('Clouds')) return 'â˜ï¸';
            if(m.includes('Rain')) return 'ğŸŒ§ï¸';
            if(m.includes('Snow')) return 'â„ï¸';
            return 'â›…';
        }

        async function askGemini(city, date, m, n, e) {
            const div = document.getElementById('ai-result');
            let safeCity = city || "BulunduÄŸun Yer";
            if(safeCity.includes("Konum")) safeCity = "Ä°stanbul";
            div.innerHTML = '<div class="loading-pulse">GardÄ±rop karÄ±ÅŸtÄ±rÄ±lÄ±yor... ğŸ‘—</div>';
            
            const prompt = `Stil danÄ±ÅŸmanÄ±sÄ±n. ${safeCity} ÅŸehrinde ${date} tarihinde hava: Sabah ${Math.round(m.main.temp)}C ${m.weather[0].main}, Ã–ÄŸle ${Math.round(n.main.temp)}C, AkÅŸam ${Math.round(e.main.temp)}C. KullanÄ±cÄ±ya kÄ±sa, samimi, emojili kÄ±yafet Ã¶nerisi ver. TÃ¼rkÃ§e.`;
            
            try {
                // MODELÄ° 1.5 FLASH OLARAK GÃœNCELLEDÄ°M ğŸ‘‡ (Daha stabil)
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({contents:[{parts:[{text:prompt}]}]})
                });
                
                if (!res.ok) {
                    throw new Error(`Hata: ${res.status}`);
                }

                const data = await res.json();
                div.innerHTML = data.candidates[0].content.parts[0].text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            
            } catch(error) { 
                div.innerHTML = `<span style="color:red; font-size:12px;">âš ï¸ ${error.message} - LÃ¼tfen 1 dk bekleyin.</span>`; 
                console.error(error);
            }
        }
    </script>